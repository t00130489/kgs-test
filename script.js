// script.js

// „Çª„ÇØ„Ç∑„Éß„É≥ÔºöÂÆöÊï∞
const TEXT = {
  preCountdownSec: 3,
  questionTimeLimit: 30,
  answerTimeLimit: 15,
  typeSpeed: 100,
  labels: {
    timeoutLabel: 'ÊÆã„Çä ',
    secondsSuffix: 'Áßí',
    statusAllWrong: 'ÂÖ®Âì°Ë™§Á≠î‚Ä¶ Ê≠£Ëß£Ôºö ',
    statusTimeUp: 'ÊôÇÈñìÂàá„ÇåÔºÅ Ê≠£Ëß£Ôºö ',
    statusCorrect: 'Ê≠£Ëß£ÔºÅüéâ',
    statusWrong: guess => `‰∏çÊ≠£Ëß£Ôºà${guess}Ôºâ`,
    nextQuestion: 'Ê¨°„ÅÆÂïèÈ°å„Å∏',
    finalResult: 'ÊúÄÁµÇÁµêÊûú„Å∏',
    returnHome: '„Éà„ÉÉ„Éó„Éö„Éº„Ç∏„Å´Êàª„Çã',
    resultsTitle: 'ÁµêÊûú',
    participantsHeader: '„É°„É≥„Éê„Éº„Å®Ê≠£Ëß£Êï∞',
    perQuestionHeader: 'ÂïèÈ°åÂà• ÂõûÁ≠î‰∏ÄË¶ß',
    correctLabel: 'Ê≠£Ëß£ËÄÖÔºö ',
    incorrectLabel: '‰∏çÊ≠£Ëß£ËÄÖÔºö ',
    timeoutLabelList: '„Çø„Ç§„É†„Ç¢„Ç¶„Éà',
    leaveConfirm: '„Ç≤„Éº„É†„Åã„ÇâÈõ¢ËÑ±„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü',
    questionLabelPrefix: 'Á¨¨',
    questionLabelSuffix: 'Âïè'
  }
};

// Èõ¢ËÑ±Á¢∫Ë™çÂà∂Âæ°
let allowUnload = false;
window.onbeforeunload = e => {
  if (!allowUnload) e.returnValue = TEXT.labels.leaveConfirm;
};

// Firebase ÂàùÊúüÂåñ
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import {
  getDatabase, ref, set, push,
  onValue, onChildAdded, remove,
  get, child,
  runTransaction // ‚Üê „Åì„Åì„ÇíËøΩÂä†
} from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

initializeApp({
  apiKey: "AIzaSyBYWW8Ldgtow1fxctSqIZynLpxFwRAcc-c",
  authDomain: "kgs-test-68924.firebaseapp.com",
  databaseURL: "https://kgs-test-68924-default-rtdb.firebaseio.com",
  projectId: "kgs-test-68924",
  storageBucket: "kgs-test-68924.appspot.com",
  messagingSenderId: "806988019711",
  appId: "1:806988019711:web:3859c3fa8182371761d9ca",
  measurementId: "G-QEP0467K9D"
});
const db = getDatabase();

// „Çµ„Éº„ÉêÊôÇÂàª„Ç™„Éï„Çª„ÉÉ„ÉàÂèñÂæó
let serverTimeOffset = 0;
onValue(ref(db, '.info/serverTimeOffset'), s => serverTimeOffset = s.val() || 0);
const getServerTime = () => Date.now() + serverTimeOffset;

// DOMÂèñÂæó
const createBtn   = document.getElementById('createBtn');
const joinRoomBtn = document.getElementById('joinRoomBtn');
const roomIdInput = document.getElementById('roomIdInput');
const homeDiv     = document.getElementById('home');
const quizAppDiv  = document.getElementById('quiz-app');
const resultsDiv  = document.getElementById('results');
const currentRoom = document.getElementById('currentRoomId');
const chapterCbs  = document.querySelectorAll('#chapter-selection input[type=checkbox][value]');
const gradCb      = document.getElementById('grad-range');
const allCb       = document.getElementById('all-range');
const roomCount   = document.getElementById('room-count');
const roomRange   = document.getElementById('room-range');
const currentNum  = document.getElementById('currentNum');
const totalNum    = document.getElementById('totalNum');
const playersUl   = document.getElementById('players');
const statusEl    = document.getElementById('status');
const preCd       = document.getElementById('pre-countdown');
const questionEl  = document.getElementById('question');
const qTimerEl    = document.getElementById('question-timer');
const buzzBtn     = document.getElementById('buzzBtn');
const answerArea  = document.getElementById('answer-area');
const answerInput = document.getElementById('answerInput');
const answerBtn   = document.getElementById('answerBtn');
const aTimerEl    = document.getElementById('answer-timer');
const nextBtn     = document.getElementById('nextBtn');
const startBtn    = document.getElementById('startBtn');

// „ÄåÁ¨¨„ÄáÂïè„Äç„É©„Éô„É´
const questionLabelEl = document.createElement('div');
questionLabelEl.id = 'questionLabel';
questionLabelEl.className = 'question-label';
questionLabelEl.style.visibility = 'hidden';
quizAppDiv.insertBefore(questionLabelEl, preCd);

// „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„Ç™„Éº„Éê„Éº„É¨„Ç§ÂèñÂæó
const feedbackOverlay = document.getElementById('feedback-overlay');

// „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØË°®Á§∫
function showFeedback(isCorrect) {
  feedbackOverlay.textContent = isCorrect ? '„Äá' : '√ó';
  feedbackOverlay.classList.remove('hidden', 'correct', 'wrong');
  feedbackOverlay.classList.add(isCorrect ? 'correct' : 'wrong');
  setTimeout(() => {
    feedbackOverlay.classList.add('hidden');
  }, 800);
}

// Áä∂ÊÖãÂ§âÊï∞
let quizData = [], sequence = [], idx = 0;
let myNick = '', roomId = '', joinTs = 0;
let players = {}, scores = {}, wrongs = {};
let flowStarted = false, answered = false;
let questionStart = 0, remainingQTime = TEXT.questionTimeLimit;
const allEvents = [];

// „Çø„Ç§„Éû„ÉºÔºÜ„Çø„Ç§„Éó„ÇØ„É™„Ç¢
function clearTimers(){
  clearInterval(window._preInt);
  clearInterval(window._qInt);
  clearInterval(window._aInt);
  clearInterval(window._typeInt);
}
function canBuzz(){ return flowStarted && !answered && !wrongs[myNick]; }
function updateBuzzState(){
  buzzBtn.disabled = !canBuzz();
  buzzBtn.classList.toggle('disabled-btn', !canBuzz());
}
function updateCreateBtn(){
  createBtn.disabled = !quizData.length || ![...chapterCbs].some(cb=>cb.checked);
}

// Ë≥™Âïè„Çø„Ç§„Éû„Éº
function tickQ(){
  if(!flowStarted) return;
  const elapsed = (getServerTime() - questionStart) / 1000;
  remainingQTime = Math.max(0, TEXT.questionTimeLimit - elapsed).toFixed(1);
  qTimerEl.textContent = TEXT.labels.timeoutLabel + remainingQTime + TEXT.labels.secondsSuffix;
  if(remainingQTime <= 0 && !answered){
    clearTimers();
    onQuestionTimeout();
  }
}

// „Çø„Ç§„É†„Ç¢„ÉÉ„ÉóÔºöÂïèÈ°åÂà∂ÈôêÊôÇÈñì
function onQuestionTimeout(){
  clearTimers();
  answered = true;
  flowStarted = false;
  questionEl.textContent = sequence[idx].question;
  statusEl.textContent = TEXT.labels.statusTimeUp + sequence[idx].answer;
  buzzBtn.disabled = true;
  answerArea.classList.add('hidden');
  qTimerEl.style.display = 'none';
  aTimerEl.style.display = 'none';
  nextBtn.disabled = false;
  remove(ref(db, `rooms/${roomId}/buzz`));
}

// ÂàùÊúüUI
createBtn.disabled = true;
answerArea.classList.add('hidden');
answerBtn.disabled = true;
buzzBtn.disabled = true; buzzBtn.classList.add('disabled-btn');
startBtn.style.display = 'none';
qTimerEl.style.display = 'none';
aTimerEl.style.display = 'none';

// ÁØÑÂõ≤„Éó„É™„Çª„ÉÉ„Éà
gradCb.addEventListener('change', ()=>{ chapterCbs.forEach(cb=>{ if(['0','1','4','7'].includes(cb.value)) cb.checked=gradCb.checked; }); updateCreateBtn(); });
allCb.addEventListener('change', ()=>{ chapterCbs.forEach(cb=>cb.checked=allCb.checked); updateCreateBtn(); });
chapterCbs.forEach(cb=>cb.addEventListener('change',updateCreateBtn));

// ÂïèÈ°å„É≠„Éº„ÉâÔºàÊúÄÂàù„Å†„ÅëÂèñÂæó„ÄÅ‰ª•Èôç„ÅØÁõ£Ë¶ñ„Åó„Å™„ÅÑÔºâ
get(ref(db,'questions')).then(snap => {
  quizData = Object.values(snap.val()||{}).filter(x=>x);
  updateCreateBtn();
});

// „Ç¶„Ç©„ÉÉ„ÉÅ„É£„Éº
function watchPlayers(){
  onValue(ref(db,`rooms/${roomId}/players`), snap=>{
    players = snap.val()||{}; playersUl.innerHTML='';
    Object.keys(players).forEach(nick=>{
      const li = document.createElement('li');
      li.textContent = `${nick} (${scores[nick]||0}ÂïèÊ≠£Ëß£)`;
      playersUl.appendChild(li);
    });
  });
}
function watchScores(){
  onValue(ref(db,`rooms/${roomId}/scores`), snap=>{ scores = snap.val()||{}; watchPlayers(); });
}
function watchWrongs(){
  onValue(ref(db,`rooms/${roomId}/wrongAnswers`), snap=>{
    wrongs = snap.val()||{};
    const total = Object.keys(players).length;
    if(!answered && Object.keys(wrongs).length >= total){
      clearTimers(); answered = true; flowStarted = false;
      questionEl.textContent = sequence[idx].question;
      statusEl.textContent = TEXT.labels.statusAllWrong + sequence[idx].answer;
      qTimerEl.style.display = 'none'; aTimerEl.style.display = 'none';
      answerArea.classList.add('hidden'); buzzBtn.disabled = true;
      nextBtn.disabled = false; remove(ref(db,`rooms/${roomId}/buzz`));
    }
    updateBuzzState();
  });
}
function watchSettings(){
  onValue(ref(db,`rooms/${roomId}/settings`), snap=>{
    const s = snap.val()||{};
    roomRange.textContent = (s.chapters||[]).map(c=>["Â∫èÁ´†","Á¨¨‰∏ÄÁ´†","Á¨¨‰∫åÁ´†","Á¨¨‰∏âÁ´†","Á¨¨ÂõõÁ´†","Á¨¨‰∫îÁ´†","Á¨¨ÂÖ≠Á´†","Á¨¨‰∏ÉÁ´†"][c]).join('„ÄÅ');
    totalNum.textContent = s.count||0;
  });
}
function watchSequence(){
  onValue(ref(db,`rooms/${roomId}/sequence`), snap=>{ sequence = Object.values(snap.val()||{}).filter(x=>x); });
}
function watchIndex(){
  onValue(ref(db,`rooms/${roomId}/currentIndex`), snap=>{
    idx = snap.val()||0;
    questionLabelEl.textContent = `${TEXT.labels.questionLabelPrefix}${idx+1}${TEXT.labels.questionLabelSuffix}`;
    nextBtn.textContent = idx+1>=sequence.length?TEXT.labels.finalResult:TEXT.labels.nextQuestion;
    set(ref(db,`rooms/${roomId}/wrongAnswers`),null);
  });
}
function watchEvents(){
  onChildAdded(ref(db,`rooms/${roomId}/events`), snap=>{
    const ev = snap.val(); if(ev.timestamp <= joinTs) return;
    allEvents.push(ev);
    if(ev.correct){
      clearTimers(); answered = true; flowStarted = false;
      questionEl.textContent = sequence[idx].question;
      statusEl.textContent = `${ev.nick} „Åï„Çì„ÅåÊ≠£Ëß£ÔºÅüéâ Ê≠£Ëß£Ôºö ${ev.answer}`;
      qTimerEl.style.display = 'none'; aTimerEl.style.display = 'none';
      nextBtn.disabled = false; updateBuzzState();
    } else if(ev.type==='wrongGuess' || ev.type==='answerTimeout'){
      clearTimers();
      const disp = ev.type==='wrongGuess'?ev.guess:'ÊôÇÈñìÂàá„Çå';
      statusEl.textContent = `${ev.nick} „Åï„Çì„Åå‰∏çÊ≠£Ëß£Ôºà${disp}Ôºâ`;
      flowStarted = true;
      questionStart = ev.timestamp;
      window._qInt = setInterval(tickQ,100);
      resumeTypewriter(); updateBuzzState();
    }
  });
}
function watchBuzz(){
  onValue(ref(db,`rooms/${roomId}/buzz`), snap=>{
    const b = snap.val();
    if(b && flowStarted && !answered){
      flowStarted = false; clearInterval(window._qInt); pauseTypewriter();
      statusEl.textContent = `${b.nick} „Åï„Çì„ÅåÊäº„Åó„Åæ„Åó„Åü`;
      if(b.nick===myNick){
        answerArea.classList.remove('hidden'); answerBtn.disabled=false; startAnswerTimer();
      }
      updateBuzzState();
    } else if(!b && flowStarted && !answered){
      statusEl.textContent=''; answerArea.classList.add('hidden');
      answerInput.value=''; answerBtn.disabled=true; updateBuzzState();
    }
  });
}
function watchPreStart(){
  onValue(ref(db,`rooms/${roomId}/settings/preStart`), snap=>{
    const ts=snap.val(); if(ts){ startBtn.style.display='none'; startPreCountdown(ts); }
  });
}

// „É´„Éº„É†IDÁîüÊàê
async function genId(){
  const roomsRef = ref(db,'rooms');
  let id, exists=true;
  while(exists){
    id = String(10000 + Math.floor(Math.random()*90000));
    exists = (await get(child(roomsRef,id))).exists();
  }
  return id;
}

// „É´„Éº„É†‰ΩúÊàê
createBtn.addEventListener('click',async()=>{
  if(!quizData.length){ alert('Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶'); return; }
  const chs=[...chapterCbs].filter(cb=>cb.checked).map(cb=>+cb.value);
  const cnt=parseInt(roomCount.value,10);
  if(!chs.length||cnt<1){ alert('ÁØÑÂõ≤„Å®Êï∞„ÇíÊåáÂÆö'); return; }
  const nick=prompt('„Éã„ÉÉ„ÇØ„Éç„Éº„É†Ôºà„É´„Éº„É†„Éõ„Çπ„ÉàÔºâ'); if(!nick) return;
  myNick=nick; joinTs=getServerTime(); roomId=await genId();
  await set(ref(db,`rooms/${roomId}/settings`),{chapters:chs,count:cnt,createdAt:getServerTime()});
  sequence=quizData.filter(q=>chs.includes(+q.chapter)).sort(()=>Math.random()-.5).slice(0,cnt);
  await set(ref(db,`rooms/${roomId}/sequence`),sequence);
  await set(ref(db,`rooms/${roomId}/currentIndex`),0);
  await set(ref(db,`rooms/${roomId}/players/${myNick}`),{joinedAt:joinTs});
  homeDiv.classList.add('hidden'); quizAppDiv.classList.remove('hidden');
  currentRoom.textContent=roomId; startBtn.style.display='block';
  watchPlayers(); watchScores(); watchWrongs();
  watchSettings(); watchSequence(); watchIndex();
  watchEvents(); watchBuzz(); watchPreStart();
});

// „É´„Éº„É†ÂèÇÂä†
joinRoomBtn.addEventListener('click',async()=>{
  const inputId=roomIdInput.value.trim(); if(!inputId){ alert('„É´„Éº„É†ID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
  const snap=await get(child(ref(db,'rooms'),inputId)); if(!snap.exists()){ alert('„É´„Éº„É†„ÅåÂ≠òÂú®„Åó„Åæ„Åõ„Çì'); return; }
  roomId=inputId; const nick=prompt('„Éã„ÉÉ„ÇØ„Éç„Éº„É†'); if(!nick) return;
  myNick=nick; joinTs=getServerTime();
  await set(ref(db,`rooms/${roomId}/players/${myNick}`),{joinedAt:joinTs});
  homeDiv.classList.add('hidden'); quizAppDiv.classList.remove('hidden');
  currentRoom.textContent=roomId;
  watchPlayers(); watchScores(); watchWrongs();
  watchSettings(); watchSequence(); watchIndex();
  watchEvents(); watchBuzz(); watchPreStart();
});

// „Éó„É™„Ç´„Ç¶„É≥„Éà‚ÜíÂá∫È°å
startBtn.addEventListener('click',async()=>{
  const now=getServerTime(); await set(ref(db,`rooms/${roomId}/settings/preStart`),now);
});

// „É≠„Éº„Ç´„É´„ÅßÊÆã„ÇäÁßíÊï∞„ÇíÂÖàË°åÊèèÁîª
function updateLocalCountdown(startTs) {
  const tick = () => {
    const rem = TEXT.preCountdownSec - Math.floor((getServerTime() - startTs) / 1000);
    if (rem > 0) preCd.textContent = rem;
    else {
      clearInterval(window._preInt);
      preCd.textContent = '';
    }
  };
  tick();
  window._preInt = setInterval(tick, 200);
}

function startPreCountdown(startTs){
  clearTimers(); flowStarted=false; answered=false;
  statusEl.textContent=''; answerArea.classList.add('hidden'); answerInput.value='';
  qTimerEl.style.display='none'; aTimerEl.style.display='none'; questionEl.style.visibility='hidden';
  questionLabelEl.style.visibility='visible';
  questionLabelEl.textContent=`${TEXT.labels.questionLabelPrefix}${idx+1}${TEXT.labels.questionLabelSuffix}`;
  nextBtn.disabled=true;
  // „Åæ„Åö„É≠„Éº„Ç´„É´„ÅßÂÖàË°åÊèèÁîª
  const localStartTs = getServerTime();
  updateLocalCountdown(localStartTs);
  // DB„Ç§„Éô„É≥„ÉàÂà∞ÁùÄ„ÅßÊ≠£Á¢∫„Å™startTs„Å´Ë™øÊï¥
  onValue(ref(db,`rooms/${roomId}/settings/preStart`), snap => {
    const dbStartTs = snap.val();
    if (dbStartTs) {
      clearInterval(window._preInt);
      // Ê≠£Á¢∫„Å™„Çø„Ç§„Éü„É≥„Ç∞„ÅßÂÜç„Ç´„Ç¶„É≥„Éà
      const tick = () => {
        const rem = TEXT.preCountdownSec - Math.floor((getServerTime() - dbStartTs) / 1000);
        if (rem > 0) preCd.textContent = rem;
        else {
          clearInterval(window._preInt);
          preCd.textContent = '';
          questionStart = dbStartTs + TEXT.preCountdownSec * 1000;
          flowStarted = true;
          showQuestion();
        }
      };
      tick();
      window._preInt = setInterval(tick, 200);
    }
  }, { onlyOnce: true });
}

// „Çø„Ç§„ÉóÂà∂Âæ°
let typePos=0, currentText='';
function showQuestion(){
  currentText=sequence[idx].question; typePos=0;
  questionEl.textContent=''; questionEl.style.visibility='visible';
  clearInterval(window._typeInt);
  window._typeInt=setInterval(()=>{
    if(typePos<currentText.length) questionEl.textContent+=currentText[typePos++];
    else clearInterval(window._typeInt);
  }, TEXT.typeSpeed);
  currentNum.textContent=idx+1;
  clearInterval(window._qInt); qTimerEl.style.display='block';
  questionStart=getServerTime(); remainingQTime=TEXT.questionTimeLimit;
  window._qInt=setInterval(tickQ,100); updateBuzzState();
}
function pauseTypewriter(){ clearInterval(window._typeInt); }
function resumeTypewriter(){
  clearInterval(window._typeInt);
  window._typeInt=setInterval(()=>{
    if(typePos<currentText.length) questionEl.textContent+=currentText[typePos++];
    else clearInterval(window._typeInt);
  }, TEXT.typeSpeed);
}

// Ëß£Á≠î„Çø„Ç§„Éû„Éº
function startAnswerTimer(){
  clearInterval(window._aInt);
  let s=TEXT.answerTimeLimit;
  aTimerEl.style.display='block';
  aTimerEl.textContent=TEXT.labels.timeoutLabel+s+TEXT.labels.secondsSuffix;
  window._aInt=setInterval(async()=>{
    s--;
    if(s<0){
      clearInterval(window._aInt);
      // Ëß£Á≠îÊôÇÈñìÂàá„Çå„Ç§„Éô„É≥„Éà
      await push(ref(db,`rooms/${roomId}/events`),{
        nick:myNick,correct:false,guess:'ÊôÇÈñìÂàá„Çå',
        answer:sequence[idx].answer,type:'answerTimeout',
        questionIndex:idx,timestamp:getServerTime()
      });
      await set(ref(db,`rooms/${roomId}/wrongAnswers/${myNick}`),true);
      answerArea.classList.add('hidden'); answerInput.value='';
      remove(ref(db,`rooms/${roomId}/buzz`));
    } else {
      aTimerEl.textContent=TEXT.labels.timeoutLabel+s+TEXT.labels.secondsSuffix;
    }
  },1000);
}

// Êó©Êäº„Åó„Éú„Çø„É≥Âá¶ÁêÜÔºà„Éà„É©„É≥„Ç∂„ÇØ„Ç∑„Éß„É≥ÔºãÊ•ΩË¶≥ÁöÑUIÂèçÊò†Ôºâ
buzzBtn.addEventListener('click', async () => {
  if (!canBuzz()) return;
  clearInterval(window._qInt);
  pauseTypewriter();

  // Ê•ΩË¶≥ÁöÑUIÂèçÊò†
  statusEl.textContent = `${myNick} „Åï„Çì„ÅåÊäº„Åó„Åæ„Åó„ÅüÔºàÂà§ÂÆö‰∏≠‚Ä¶Ôºâ`;

  const buzzRef = ref(db, `rooms/${roomId}/buzz`);
  await runTransaction(buzzRef, current => {
    if (current === null) {
      return {
        nick: myNick,
        time: getServerTime()
      };
    }
    return;
  }).then(result => {
    if (!result.committed) {
      // Â§±ÊïóÊôÇ„É≠„Éº„É´„Éê„ÉÉ„ÇØ
      // ÂÖà„Å´Êäº„Åó„Åü‰∫∫„ÅÆÂêçÂâç„ÇíÂèñÂæó„Åó„Å¶Ë°®Á§∫
      get(buzzRef).then(snap => {
        const buzzData = snap.val();
        const who = buzzData && buzzData.nick ? buzzData.nick : 'Ë™∞„Åã';
        statusEl.textContent = `${who} „Åï„Çì„ÅåÂÖà„Å´Êäº„Åó„Åæ„Åó„Åü‚Ä¶`;
      });
      // ÂõûÁ≠îÊ¨Ñ„Éª„Éú„Çø„É≥„Éª„Çø„Ç§„Éû„Éº„ÇíÈùûË°®Á§∫„Å´„Åó„ÄÅÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
      answerArea.classList.add('hidden');
      answerBtn.disabled = true;
      aTimerEl.style.display = 'none';
      answerInput.value = '';
      // Êó©Êäº„ÅóÊú™ÂèÇÂä†Áä∂ÊÖã„Å´Êàª„Åô
      answered = false;
      // „Çø„Ç§„É†„Ç¢„ÉÉ„ÉóË™§Á≠îÁ≠â„ÅÆÂá¶ÁêÜ„ÅØË°å„Çè„Å™„ÅÑ
    }
    // ÊàêÂäüÊôÇ„ÅØwatchBuzz„ÅßUIÁ¢∫ÂÆö
  });
});

// Ëß£Á≠îÊèêÂá∫
answerBtn.addEventListener('click',async()=>{
  answerBtn.disabled = true;
  const guess = answerInput.value.trim();
  if (!guess) { alert('ÂõûÁ≠î„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); answerBtn.disabled = false; return; }
  const corr = sequence[idx].answer.trim();
  const isCorrect = (guess === corr);

  // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØË°®Á§∫
  showFeedback(isCorrect);

  // „Ç§„Éô„É≥„Éà„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê
  const ev = {
    nick: myNick,
    correct: isCorrect,
    guess: guess,
    answer: corr,
    questionIndex: idx,
    timestamp: getServerTime()
  };
  if (!isCorrect) {
    ev.type = 'wrongGuess';
  }

  // Firebase „Å´ÈÄÅ‰ø°
  await push(ref(db, `rooms/${roomId}/events`), ev);

  if (isCorrect) {
    // Ê≠£Ëß£Âá¶ÁêÜ
    const sr = ref(db, `rooms/${roomId}/scores/${myNick}`);
    const snap = await get(sr), prev = snap.exists() ? snap.val() : 0;
    await set(sr, prev + 1);

    clearTimers();
    answered = true;
    flowStarted = false;

    questionEl.textContent = sequence[idx].question;
    statusEl.textContent = `${myNick} „Åï„Çì„ÅåÊ≠£Ëß£ÔºÅüéâ Ê≠£Ëß£Ôºö ${corr}`;
    buzzBtn.disabled = true;
    answerArea.classList.add('hidden');
    qTimerEl.style.display = 'none';
    aTimerEl.style.display = 'none';
    nextBtn.disabled = false;

    await remove(ref(db, `rooms/${roomId}/buzz`));
    updateBuzzState();
  } else {
    // Ë™§Á≠îÂá¶ÁêÜ
    clearTimers();
    await set(ref(db, `rooms/${roomId}/wrongAnswers/${myNick}`), true);
    answerArea.classList.add('hidden');
    answerInput.value = '';
    await remove(ref(db, `rooms/${roomId}/buzz`));
    // ÂïèÈ°å„Çø„Ç§„Éû„Éº„ÇíÂÜçÈñãÔºà‰ªñ„ÅÆ‰∫∫„ÅÆÊó©Êäº„ÅóÂæÖ„Å°Áä∂ÊÖã„Å´Êàª„ÅôÔºâ
    if (flowStarted) {
      window._qInt = setInterval(tickQ, 100);
    }
  }
});

// Ê¨°„Å∏
nextBtn.addEventListener('click',async()=>{
  if(nextBtn.disabled) return;
  clearTimers();
  questionEl.textContent=''; questionEl.style.visibility='hidden';
  statusEl.textContent=''; qTimerEl.style.display='none'; aTimerEl.style.display='none';
  questionLabelEl.style.visibility='hidden';
  if(idx+1<sequence.length){
    await set(ref(db,`rooms/${roomId}/currentIndex`),idx+1);
    await set(ref(db,`rooms/${roomId}/settings/preStart`),getServerTime());
  } else {
    showResults();
  }
});

// ÁµêÊûúË°®Á§∫
async function showResults(){
  quizAppDiv.classList.add('hidden');
  resultsDiv.classList.remove('hidden');
  allowUnload = true;

  const ps = await get(ref(db,`rooms/${roomId}/players`));
  const sc = await get(ref(db,`rooms/${roomId}/scores`));
  players = ps.val() || {};
  scores = sc.val() || {};

  const scoreValues = Object.values(scores).map(v => v || 0);
  const maxScore = scoreValues.length ? Math.max(...scoreValues) : 0;
  const winners = maxScore > 0
    ? Object.keys(scores).filter(nick => (scores[nick] || 0) === maxScore)
    : [];

  let html = `<h2>${TEXT.labels.resultsTitle}</h2>`;
  if(winners.length){
    html += `<h3 class="champion-announcement">üèÜ ÂÑ™ÂãùËÄÖÔºö${winners.join('„ÄÅ')}Ôºà${maxScore}ÂïèÊ≠£Ëß£Ôºâ</h3>`;
  } else {
    html += `<h3 class="champion-announcement">üèÜ ÂÑ™ÂãùËÄÖ„Å™„Åó</h3>`;
  }
  html += `<h3>${TEXT.labels.participantsHeader}</h3><ul>`;
  Object.keys(players).forEach(nick => {
    const score = scores[nick] || 0;
    const cls = winners.includes(nick) ? ' class="winner"' : '';
    html += `<li${cls}>${nick}Ôºö${score}ÂïèÊ≠£Ëß£</li>`;
  });
  html += `</ul><h3>${TEXT.labels.perQuestionHeader}</h3>`;
  sequence.forEach((q, i) => {
    html += `<div><h4>Á¨¨${i+1}ÂïèÔºö ${q.question}</h4><p>Ê≠£Ëß£Ôºö ${q.answer}</p><ul>`;
    const win = allEvents.filter(e => e.questionIndex === i && e.correct).map(e => e.nick);
    html += `<li>${TEXT.labels.correctLabel}${win.length ? win.join('„ÄÅ') : '„Å™„Åó'}</li>`;
    const los = allEvents.filter(e => e.questionIndex === i && !e.correct);
    los.forEach(e => {
      html += `<li>${TEXT.labels.incorrectLabel}${e.nick}Ôºà${e.guess || 'ÊôÇÈñìÂàá„Çå'}Ôºâ</li>`;
    });
    html += `</ul></div>`;
  });
  html += `<button id="backBtn" class="btn-primary">${TEXT.labels.returnHome}</button>`;

  resultsDiv.innerHTML = html;
  document.getElementById('backBtn').addEventListener('click', () => {
    allowUnload = true;
    location.reload();
  });
}

// Èõ¢ËÑ±ÂæåÂâäÈô§
window.addEventListener('unload',()=>{ remove(ref(db,`rooms/${roomId}/players/${myNick}`)); });
